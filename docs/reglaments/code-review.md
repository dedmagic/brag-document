# Правила проведения Code Review


## Используемые термины и сокращения

*   **PR** – пулл-реквест; содержит код, который должен пройти ревью.
*   **Автор** – автор кода, создавший PR.
*   **Канал** – канал `Developers.CodeReview` в Teams, специально созданный для решения вопросов, связанных с ревью кода.
*   **Зона** **ответственности** – код, созданный или измененный автором в процессе работы над данной задачей, т.е. весь новый и модифицированный код в PR.
*   **PR рефакторинга** – пулл-реквест, содержащий изменения в рамках рефакторинга кода.
  

## Правила проведения

1.  Периодичность проведения ревью
    1.  Каждый ревьювер должен обрабатывать все имеющиеся на данный момент PR не реже, чем дважды в день. Время проведения ревью выбирается ревьювером самостоятельно.
    2.  Автор не может ни требовать, ни просить немедленного или ускоренного проведения ревью своего кода без веских на то причин.
    3.  В случае, если задача имеет высокую срочность (срочность задачи определяется аналитиками или руководством), автор должен сообщить об этом в канале код-ревью. Если прохождение таких ревью недопустимо затягивается, автор может и должен ускорять процесс любыми способами, не нарушающими Уголовный Кодекс и/или правила приличия.
    4.  Пулл-реквест, находящийся на код-ревью, может стать блокирующим – в том случае, если уже готовы для прохождения код-ревью следующие изменения по этой же задаче. Приёмы работы с блокирующими пулл-реквестом такие же, как и со срочными (см. п. **1.c**).  
        Внимание! Разработчик не может по своему усмотрению присваивать пулл-реквесту статус "блокирующий", условия для этого описаны выше. Из этого следует, что:  
        а) Пулл-реквест не может стать блокирующим сразу при появлении: разработчик должен сначала накодить изменений для следующего код-ревью.  
        б) Если пулл-реквест объявлен блокирующим, сразу после его завершения должен появиться следующий **по этой же задаче**.        
    5.  Если пулл-реквест не завершён в течении суток **из-за низкой активности ревьюверов**, то он переходит в разряд блокирующих со всеми вытекающими последствиями, в т.ч. автор получает право поднять шум в канале код-ревью.
2.  Статусы PR  
    1.  В случае, если в ходе ревью рецензент оставляет в PR хотя бы один комментарий, он может перевести этот PR в статус «Wait for author».
    2.  Если у ревьювера нет никаких предложений по улучшению кода (или их нет сразу, или их не стало в результате совместной с автором работы над кодом), то он должен перевести PR в статус «Approve» (или «Approve with suggestions», если по оставшимся комментариям решение оставляется на усмотрение автора). Также рецензент может утвердить пулл-реквест, если право принять решение по всем своим комментариям он оставляет за автором.
    3.  В случае, если PR переведён в статус «Approve» или «Approve with suggestions» всеми овнерами и суммарно как минимум двумя ревьюверами (включая овнеров), и нет ни одного статуса «Wait for author», а также ни одного активного комментария, этот PR может быть завершен. Сделать это может только автор PR.
    4.  В случае форс-мажорных обстоятельств (например, работа в выходной день, аврал) автор имеет право самостоятельно утвердить и завершить PR.
3.  Статусы комментариев  
    1.  Любой созданный ревьювером комментарий в PR имеет статус «Active». В процессе работы автора над комментариями все они должны изменить свой статус на «Resolved» или «Won’t fix».
    2.  Если автор не согласен с предлагаемыми ревьювером изменениями, он должен перевести комментарий в статус «Won’t fix» и обязательно в ответе на комментарий объяснить, почему он против этих изменений. Возражения должны быть обоснованными, вкусовщина или голословные утверждения не допускаются.
    3.  Если автор согласен с предложением ревьювера, он должен соответствующим образом модифицировать код и перевести комментарий в статус «Resolved». Отвечать на комментарий в этом случае не нужно! Статус меняется только после того, как изменения попадут в PR (т.е. только после "пуша").
    4.  Если автор согласен с предложением ревьювера, но не имеет возможность в данный момент внести нужные изменения в код (из-за недостатка времени), то он обязан пометить этот участок кода как технический долг (см. далее «Пометка “Технический долг”») и перевести комментарий в статус «Won’t fix».
    5.  Если комментарий относится к коду, не входящему в зону ответственности автора, и автор не может за приемлемое время определить, являются ли предлагаемые ревьювером изменения необходимыми и/или допустимыми, он должен перевести комментарий в статус «Won’t fix» и в ответе указать, что это не его зона ответственности.
4.  Зона ответственности и правомочность требований  
    1.  Ревьювер не может предлагать автору изменения в коде, который не входит в зону ответственности.
    2.  Исключение: если изменение тривиально и не требует глубокого вникания в код и много времени на его реализацию (например, поправить форматирование), то ревьювер может предложить данное изменение, а автор, если он не козёл, отнесётся к этому спокойно.
    3.  Ревьювер не может требовать от автора следования каким-либо правилам/принципам, если они не прописаны в нормативных документах группы. Если ревьювер считает, что данное правило должно соблюдаться, он должен инициировать процесс внесения этого правила в нормативные документы.
    4.  Автор имеет право потребовать разъяснить, какое именно правило регламента нарушено по мнению ревьювера. Ревьювер должен предоставить ссылку на правило в любой форме, позволяющей найти это правило в регламентных документах.  
5.  Использование канала  
    1.  Канал код-ревью может использоваться только в двух целях. Первая – в случае, если ревью имеет высокую срочность или PR блокирует дальнейшую работу. В этом случае автор должен в канале оповестить всех об этом, а далее все участники процесса могут сообщать информацию, позволяющую ускорить прохождение ревью.
    2.  Второй случай: если обсуждение некоторого фрагмента кода слишком объёмно и не может быть проведено в комментариях в PR, то допускается перенести это обсуждение в канал.
    3.  Канал код-ревью не может использоваться ни для каких других целей. В т.ч. нельзя в нём оповещать вселенную о своих действиях (исключение – п.5.a).
6.  Код-ревью хотфиксов
    1.  PR хотфиксов (из ветки, имя которой начинается с **hotfix**, в ветку **master**) необходимо проверять только на наличие багов. Вопросы, связанные с качеством кода, в рамках таких PR не рассматриваются, проведение какого-либо рефакторинга ревьюверами не предлагается.
    2.  Автор хотфикса кроме PR в ветку **master** должен создать второй аналогичный PR в ветку **develop**. Этот PR проходит через стандартную процедуру код-ревью.
7.  Заголовки и описания PR
    1.  Заголовки всех PR, кроме PR рефакторинга (см. следующий раздел), должны иметь следующий формат: **`#<номер WI> <Краткое описание изменений в коде>`**. Заголовок заполняется при создании PR.  
        Например: **#224583 Добавлен шаблон нового отчёта**.
    2.  При завершении PR в начало его заголовка нужно добавить текст **Merged PR <номер PR>:**. Таким образом, заголовок примет вид **Merged PR 56783: #224583 Реализация АО4 – добавлен шаблон отчёта**.
    3.  В описании (decription) PR необходимо более подробно перечислить внесённые в код изменения. Описание PR заполняется при его создании.
8.  PR рефакторинга
    1.  Для проведения рефакторинга следует создавать отдельную ветку (от **develop** или от греческой ветки, в зависимости от того, в какой ветке выполняется задача), выполнять в ней **ровно один вид рефакторинга** и отправлять на код-ревью. Для ускорения прохождения данного PR (т.к. он может являться блокирующим) допускается оповещать о нем в канале автора.
    2.  Ещё раз: в одном PR рефакторинга должен содержаться **единственный** рефакторинг. Если PR нарушает это правило, код-ревьювер должен после обсуждения с автором отклонить (**Abandon**) этот PR.
    3.  Заголовки PR рефакторинга должны иметь следующий формат: **#<номер WI> Рефакторинг: <название рефакторинга с указанием измененных программных объектов>**. Заголовок заполняется при создании PR.  
        Например: **#224583 Рефакторинг: переименование метода FooClass.Zoo в Boo.**
    4.  При завершении PR в начало его заголовка нужно добавить текст **Merged PR <номер PR>:**. Таким образом, заголовок примет вид **Merged PR 56783: #224583 Рефакторинг: переименование метода FooClass.Zoo в Boo**.
    5.  В описании (decription) PR необходимо кратко перечислить внесённые в код изменения. Описание PR заполняется при его создании.
9.  Прочее
    1.  Крупные задачи желательно выполнять в отдельных ветках (alpha, beta, ...) и загружать в них код по частям разными PR, чтобы на код-ревью не оказался слишком большой объём информации.
    2.  При вынесении больших объёмов легаси-кода в новые файлы, необходимо в начале этих файлов разместить TODO с указанием того, что это – легаси, требующее рефакторинга, и датой, когда этот комментарий был добавлен. Также необходимо перечислить эти файлы в описании (Description) пулл-реквеста, чтобы ревьюверы не тратили своё время на анализ их кода.
    3.  Отношение к ревью: ревью кода – это не модель взаимоотношений «студент – экзаменатор» или «подчинённый – начальник». Это совместная работа коллег над улучшением кодовой базы. Поэтому, со стороны ревьюверов не допускаются «начальственные» мотивы, например, требование изменить код, а со стороны авторов – безусловное деление кода на «мой / чужой».

## Пометка кода «Технический долг»

Если в коде обнаружена проблема, которая по каким-либо причинам не может быть исправлена прямо сейчас, то данный код должен быть помечен как технический долг. Для этого создается таск в tfs с подробным описанием в каком компоненте и что необходимо сделать. А также перед этим участком кода размещается комментарий, состоящий из следующих частей:

1.  Слово «TODO», в точно таком виде, как оно приведено здесь.
2.  Номер таска в формате #<номер WI>
3.  Трудоёмкость решения проблемы в неделях (w) / днях (d) / часах (h) / минутах (m).
4.  Описание проблемы. Это описание должно быть контекстно-независимым, т.е. понятным не только автору описания здесь и сейчас, но и любому другому читателю, который может не владеть ситуацией в том же объеме, что и автор.
5.  Если автор комментария видит возможные пути решения указанной проблемы, он может помочь будущим поколениям, приведя их в данном комментарии.

Пример: 

```csharp
// TODO #2654173 (2h): Эти два метода сильно дублируют друг друга, объединить в один
```

Требование к таску:

1.  Описание должно быть достаточно подробным и контекстно-независимым, т.е. понятным не только автору описания здесь и сейчас, но и любому другому читателю, который может не владеть ситуацией в том же объеме, что и автор.
2.  В описании должно присутствовать наименование класса, в котором есть TODO, относящееся к этой проблеме
3.  В поле Unplanned должен быть указан "Техдолг"
4.  У задачи должен быть указан правильный родитель. Допустимо указывать требование той фичи, в рамках которой добавляется этот техдолг. Если по какой-то причине этого лучше не делать или это вообще невозможно, тогда использовать общее требование
5.  Таск должен содержать тег подсистемы, к которой он относится. Например, "ПРЧБ"
6.  У таска должны быть заполнены поля Original Estimate и Remaining Work