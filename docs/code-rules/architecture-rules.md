# Архитектурные требования

1. Общие требования
    1. Запрещено добавлять или редактировать код в классах, помеченных как легаси (имеющих суффикс `Legacy`). Единственное действие, которое допускается, и, более того, приветствуется – удаление кода из этих классов.
2. Код общего назначения (проект `ProjectA.CommonLib`)
    1. В библиотеке общего назначения может быть только код, никак не зависящий от предметной области. Таким образом, недопустимо использование пространств имён, начинающихся с `ProjectA.SubsystemB`.
3. Веб-проект (`ProjectA.SubsystemB.Web`)
    1. В веб-проекте запрещено использовать типы из DAL-проекта (пространства имён `ProjectA.SubsystemB.Dal...`).
    2. Методы действий (actions) контроллеров могут содержать только логику маршрутизации (routing). Все действия по построению моделей представлений (view models) должны быть делегированы классам `...VmBulder`, действия по изменению состояния системы – уровню бизнес-логики (сервисам).
    3. Для каждого контроллера должен быть один класс с суффиксом `...VmBuilder` в имени (н-р, `CalcAndRateController.cs` → `CalcAndRateVmBuilder.cs`). Эти классы располагаются в папке `ProjectA.SubsystemB.Web\VmBuilders`.    
    Ответственность данных классов – формировать модели представлений (view models) по требованиям контроллеров.    
    Каждый метод такого класса служит для формирования одной модели представления. Единственная функция такого метода – извлечь нужные данные с помощью сервисов бизнес-логики и сформировать из этих данных модель представления. Какая-либо иная логика в таких методах недопустима и должна быть перенесена в соответствующие сервисы.
    4. Все модели представлений должны располагаться в папке `ProjectA.SubsystemB.Web\ViewModels`.
    5. Все классы `...Query`, инкапсулирующие данные HTTP-запросов, должны располагаться в папке `ProjectA.SubsystemB.Web\Queries`.
4. Уровень бизнес-логики (проект `ProjectA.SubsystemB.Bll`)
    1. В проекте, реализующем слой бизнес-логики, не могут использоваться типы из веб-проекта (пространства имён вида `ProjectA.SubsystemB.Web....`).
    2. Запрещено использование типов стандартной библиотеки из пространств имён, содержащих в наименовании слово `Web`.
    3. Запрещено где-либо прописывать бизнес-логику, кроме как в сервисах (папка `ProjectA.SubsystemB.Bll.Services`, имена классов с суффиксом `...Service`).
    4. В сервисах запрещено использование состояния, т.е. любых полей/свойств, за исключением полей для хранения внешних зависимостей.
    5. В сервисах запрещено напрямую обращаться к контексту Entity Framework. Все действия с данными должны производиться посредством репозиториев.
    6. Работа с бизнес-сущностью может реализовываться либо одним сервисом, либо набором сервисов по отдельным ответственностям (н-р, сервис валидации, сервис работы со статусами, сервис сохранения и т.д.).
    7. В моделях бизнес-сущностей не может быть никаких методов и/или вычисляемых свойств, за исключением элементарных действий, не связанных с бизнес-логикой (например, получение ФИО из полей "Фамилия", "Имя", "Отчество").
5. Уровень доступа к данным (проект `ProjectA.SubsystemB.Dal`)
    1. В DAL-проекте запрещено использование типов из вышележащих слоёв, т.е. из пространств имён вида `ProjectA.SubsystemB.Web...` и `ProjectA.SubsystemB.Bll...`.
    2. Для каждой DAL-сущности или набора взаимосвязанных сущностей (н-р, одна главная и несколько подчинённых) создаётся один репозиторий, реализующий весь доступ к данным этих сущностей.
    3. Методы репозиториев должны быть максимально простыми, инкапсулирующими одну команду Entity Framework или несколько команд, объединенных одной бизнес-транзакцией (например, добавить элемент в контекст и сохранить изменения). Вся сложная логика должна находится в domain-слое. Таким образом, в репозиториях запрещается использование циклов (`for`, `foreach`, `while`, ...) и ветвлений (`if`, `switch`, `?:`, ...).
    4. Все методы репозиториев, возвращающие набор данных, должны возвращать тип `IQueryable<T>`.
